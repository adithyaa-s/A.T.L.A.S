name: Build and Test Docker Image

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Verify image built
      run: |
        docker build -t atlas-test:latest .
        echo "✅ Docker image built successfully"
    
    - name: Check for required files
      run: |
        test -f Dockerfile && echo "✅ Dockerfile found"
        test -f requirements.txt && echo "✅ requirements.txt found"
        test -f entrypoint.sh && echo "✅ entrypoint.sh found"
        test -f render.yaml && echo "✅ render.yaml found"
        test -f .dockerignore && echo "✅ .dockerignore found"
    
    - name: Lint Dockerfile
      run: |
        docker run --rm -i hadolint/hadolint < Dockerfile || true

  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build image for testing
      run: docker build -t atlas-test:latest .
    
    - name: Test image structure
      run: |
        # Check Python is available
        docker run --rm atlas-test:latest python --version
        
        # Check Node.js is available
        docker run --rm atlas-test:latest node --version
        
        # Check entrypoint exists
        docker run --rm atlas-test:latest test -f /app/entrypoint.sh
        
        echo "✅ All container checks passed"
